version: 2.1

.dockersetup: &dockersetup
  docker:
    - image: pennbbl/qsiprep_build:22.2.3
  working_directory: /src/qsiprep

runinstall: &runinstall
    name: Install qsiprep
    command: |
      VERSION=0+build
      if [[ -n "$CIRCLE_TAG" ]]; then
        VERSION="$CIRCLE_TAG"
      fi
      git checkout $CIRCLE_BRANCH
      echo "${VERSION}" > /src/qsiprep/qsiprep/VERSION
      echo "include qsiprep/VERSION" >> /src/qsiprep/MANIFEST.in
      find . | sort
      # pip install . --progress-bar off

      # Precaching fonts, set 'Agg' as default backend for matplotlib
      # python -c "from matplotlib import font_manager"
      # sed -i 's/\(backend *: \).*$/\1Agg/g' $( python -c "import matplotlib; print(matplotlib.matplotlib_fname())" )
      
      # Write the config file
      mkdir /root/.nipype
      CFG=/root/.nipype/nipype.cfg
      printf "[execution]\nstop_on_first_crash = true\n" > ${CFG}
      echo "poll_sleep_duration = 0.01" >> ${CFG}
      echo "hash_method = content" >> ${CFG}
      ln -s /home/qsiprep/.dipy /root/.dipy


jobs:

  build:
    <<: *dockersetup
    steps:
      - checkout
      - run: *runinstall
  
  DSCSDSI:
    <<: *dockersetup
    steps:
      - checkout
      - run: *runinstall
      - run:
          name: Run DSCSDSI tests
          command: |
            cd tests
            bash DSCSDSI.sh


  
workflows:
  version: 2
  build_test_deploy:
    jobs:
      - build:
          filters:
            tags:
              only: /.*/

      - DSCSDSI:
          requires:
            - build
          filters:
            branches:
              ignore:
                - /recon\/.*/
            tags:
              only: /.*/